<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sabor de la Vida — Учет остатков</title>

    <!-- PWA (установка как приложение) -->
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#54cf17" />
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="./icons/icon.svg" />

    <!-- Шрифт -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Иконки -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind (готовые классы для стилей) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + Babel (Babel позволяет писать JSX прямо в HTML) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase (облачная база данных) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
      :root {
        --brand: #54cf17;
        --ink: #131811;
        --bg: #f6f8f6;
      }

      body {
        font-family: "Manrope", sans-serif;
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .dark .glass-panel {
        background: rgba(22, 33, 17, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .glass-sidebar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
      }
      .dark .glass-sidebar {
        background: rgba(22, 33, 17, 0.95);
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .animate-fade-in {
        animation: fadeIn 0.25s ease-out;
      }
      .animate-slide-in {
        animation: slideIn 0.25s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      /* Поля в режиме редактирования */
      .edit-input {
        width: 100%;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        transition: all 0.2s;
      }
      .edit-input:hover {
        border-color: rgba(156, 163, 175, 0.5);
      }
      .edit-input:focus {
        background: rgba(255, 255, 255, 0.5);
        border-color: var(--brand);
        outline: none;
        box-shadow: 0 0 0 2px rgba(84, 207, 23, 0.2);
      }
      .dark .edit-input:focus {
        background: rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>

  <body class="bg-[var(--bg)] text-[var(--ink)]">
    <div id="root"></div>

    <script>
      // Авто-тёмная тема по настройке системы (можно удалить)
      try {
        if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
          document.documentElement.classList.add("dark");
        }
      } catch (_) {}
    </script>

    <script>
      // Регистрируем Service Worker (нужно для “установки” и кеша)
      try {
        if ("serviceWorker" in navigator) {
          window.addEventListener("load", () => {
            navigator.serviceWorker.register("./sw.js").catch((e) => console.warn("SW error:", e));
          });
        }
      } catch (_) {}
    </script>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      // =========================
      // Supabase (облачная БД)
      // =========================
      // **Supabase**: сервис “облачная база данных” (как общая таблица в интернете).
      // ВНИМАНИЕ: **anon key** НЕ является “секретом” (он может лежать в браузере),
      // но безопасность обеспечивается **RLS** (Row Level Security = правила доступа к строкам в таблицах).
      //
      // 1) Создайте проект в Supabase
      // 2) Возьмите Project URL и anon key: Settings → API
      // 3) Вставьте значения ниже
      const SUPABASE_URL = "https://fjpxoeohkxuldimwfnul.supabase.co"
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqcHhvZW9oa3h1bGRpbXdmbnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NDcxODAsImV4cCI6MjA4NDIyMzE4MH0.UnMs6CQnjFtMhxj6c2ay4pwOzM9cacc7mJGXlphZ4eU"; // длинная строка "anon public"

      // Общий пароль для всех посетителей:
      // 1) Создайте в Supabase одного пользователя с этим email (любым вашим) и ОДНИМ паролем
      // 2) В приложении люди будут вводить только пароль
      const SHARED_AUTH_EMAIL = "witek746653@gmail.com";

      // **Auth**: вход по email/паролю (как “замок на дверь”).
      // Если true — приложение потребует логин, и только залогиненный пользователь сможет читать/писать в Supabase (через RLS).
      const SUPABASE_REQUIRE_AUTH = true;

      function isSupabaseConfigured() {
        return Boolean(SUPABASE_URL && SUPABASE_ANON_KEY && String(SUPABASE_URL).startsWith("http"));
      }

      function createSupabaseClient() {
        if (!isSupabaseConfigured()) return null;
        if (!window.supabase || typeof window.supabase.createClient !== "function") {
          console.warn("Supabase JS не загрузился (нет window.supabase.createClient).");
          return null;
        }
        return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }

      // --- Категории (4 вкладки) ---
      const WINE_CATEGORIES = ["игристое", "красное", "белое", "розовое"];

      // --- Данные по умолчанию ---
      // Раньше здесь были “примерные” позиции. По вашей просьбе — убрано.
      // Если ни Excel, ни localStorage, ни Supabase не дали данных — список будет пустым.
      const INITIAL_WINES = [];

      // **localStorage**: «память» браузера. Данные останутся после перезагрузки страницы.
      const STORAGE_KEY = "vino_del_mar_inventory_v1";

      function safeNumber(value, fallback = 0) {
        // Excel иногда отдаёт числа как строки: "11 050", "8", "8,0"
        if (value === null || value === undefined) return fallback;
        if (typeof value === "number") return Number.isFinite(value) ? value : fallback;
        const s = String(value)
          .replace(/\u00A0/g, " ") // NBSP -> space
          .replace(/\s+/g, "") // убрать пробелы-разделители тысяч
          .replace(",", "."); // запятая -> точка
        const n = Number(s);
        return Number.isFinite(n) ? n : fallback;
      }

      function normalizeCategory(value) {
        const raw = String(value ?? "").trim().toLowerCase();
        // Разрешаем только 4 категории (иначе — пусто, будет видно во "всех" винах)
        return WINE_CATEGORIES.includes(raw) ? raw : "";
      }

      function normalizeWine(w) {
        return {
          id: String(w.id ?? ""),
          category: normalizeCategory(w.category ?? w["Категория"] ?? w.type),
          name: String(w.name ?? "Без названия"),
          region: String(w.region ?? ""),
          price: safeNumber(w.price, 0),
          discountPrice: safeNumber(w.discountPrice, 0),
          quantity: Math.max(0, Math.floor(safeNumber(w.quantity, 0))),
        };
      }

      function loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return null;
          const normalized = parsed.map(normalizeWine).filter((w) => w.id);
          return normalized.length ? normalized : null;
        } catch (e) {
          console.warn("Не смог прочитать localStorage:", e);
          return null;
        }
      }

      function saveToStorage(wines) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(wines));
        } catch (e) {
          console.warn("Не смог сохранить в localStorage:", e);
        }
      }

      function makeId() {
        return `wine_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      }

      function formatRub(value) {
        // Форматируем число "по-русски" (например: 29 900,00), БЕЗ знака ₽
        return new Intl.NumberFormat("ru-RU", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(safeNumber(value, 0));
      }

      function normalizeText(value) {
        return String(value ?? "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function normalizeHeader(value) {
        return normalizeText(value).toLowerCase();
      }

      function isRowEmpty(row) {
        return !Array.isArray(row) || row.every((c) => !normalizeText(c));
      }

      function detectHeaderRowIndex(rows) {
        // В файлах Excel иногда есть 1-2 пустые/служебные строки сверху.
        // Найдем строку, где есть "наимен/назван" + "цена" и т.п.
        const maxScan = Math.min(rows.length, 15);
        for (let i = 0; i < maxScan; i++) {
          const row = rows[i] || [];
          const cells = row.map(normalizeHeader).filter(Boolean);
          if (cells.length < 2) continue;

          const hasName = cells.some((c) => c.includes("наимен") || c.includes("назван"));
          const hasPrice = cells.some((c) => c.includes("цена"));
          const hasQty = cells.some((c) => c.includes("кол") || c.includes("остат") || c === "ед." || c.includes("ед"));
          const score = (hasName ? 1 : 0) + (hasPrice ? 1 : 0) + (hasQty ? 1 : 0);
          if (score >= 2) return i;
        }
        return 0;
      }

      function buildColumnIndexMap(headerRow) {
        const map = {
          id: null,
          category: null,
          name: null,
          region: null,
          quantity: null,
          price: null,
          discountPrice: null,
        };

        (headerRow || []).forEach((cell, idx) => {
          const h = normalizeHeader(cell);
          if (!h) return;

          // Название
          if (map.name === null && (h.includes("наимен") || h.includes("назван"))) map.name = idx;

          // Регион/страна (если вдруг есть)
          if (map.region === null && (h.includes("регион") || h.includes("страна"))) map.region = idx;

          // Количество / остаток / единицы
          if (
            map.quantity === null &&
            (h.includes("остат") || h.includes("колич") || h.includes("кол-во") || h === "ед." || h.startsWith("ед"))
          ) {
            map.quantity = idx;
          }

          // Категория/тип
          if (map.category === null && (h.includes("катег") || h.includes("тип"))) map.category = idx;

          // Цена
          if (map.price === null && h.includes("цена") && !h.includes("скид") && !h.includes("%") && !h.includes("-25")) {
            map.price = idx;
          }
          // Цена со скидкой
          if (
            map.discountPrice === null &&
            (h.includes("скид") || h.includes("%") || h.includes("-25") || h.includes("со скид"))
          ) {
            map.discountPrice = idx;
          }
        });

        // В вашем файле часто бывает нумерация в колонке A без заголовка.
        // Если не нашли явный id — считаем, что это первый столбец.
        if (map.id === null) map.id = 0;

        return map;
      }

      function parseExcelToWines(arrayBuffer) {
        if (!window.XLSX) throw new Error("XLSX not loaded");
        const workbook = window.XLSX.read(arrayBuffer, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Берем все строки как массивы (header:1), чтобы самим выбрать строку заголовков
        const rows = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
        if (!Array.isArray(rows) || rows.length === 0) return [];

        let headerRowIndex = detectHeaderRowIndex(rows);
        let headerRow = rows[headerRowIndex] || [];
        let col = buildColumnIndexMap(headerRow);

        // Если заголовки не распознаны (а имена вин распознаются по колонке B),
        // используем простой fallback под ваш формат:
        // A = №, B = Наименование, C = ед., D = цена, E = цена -25%
        const missingCritical = col.name === null || col.price === null || col.discountPrice === null || col.quantity === null;
        if (missingCritical) {
          // Попробуем ещё раз найти заголовок чуть глубже (иногда сверху много пустых строк)
          const maxScan = Math.min(rows.length, 50);
          for (let i = 0; i < maxScan; i++) {
            const candidate = rows[i] || [];
            const cells = candidate.map(normalizeHeader).filter(Boolean);
            if (!cells.length) continue;
            const hasName = cells.some((c) => c.includes("наимен") || c.includes("назван"));
            const hasPrice = cells.some((c) => c.includes("цена"));
            if (hasName && hasPrice) {
              headerRowIndex = i;
              headerRow = candidate;
              col = buildColumnIndexMap(headerRow);
              break;
            }
          }
        }

        const stillMissing = col.price === null || col.discountPrice === null || col.quantity === null;
        if (stillMissing) {
          col = {
            ...col,
            name: col.name ?? 1,
            quantity: col.quantity ?? 2,
            price: col.price ?? 3,
            discountPrice: col.discountPrice ?? 4,
          };
        }

        const wines = [];
        let currentCategory = "";

        for (let i = headerRowIndex + 1; i < rows.length; i++) {
          const row = rows[i];
          if (isRowEmpty(row)) continue;

          const rawId = normalizeText(row[col.id]);
          const rawName = normalizeText(row[col.name ?? 1]);

          // В файле могут быть "строки-разделители" категорий (например: "Игристое")
          const maybeCat = normalizeCategory(rawName);
          const isCategoryRow = !rawId && maybeCat && safeNumber(row[col.price ?? -1], 0) === 0 && safeNumber(row[col.quantity ?? -1], 0) === 0;
          if (isCategoryRow) {
            currentCategory = maybeCat;
            continue;
          }

          const categoryFromCol = col.category !== null ? normalizeCategory(row[col.category]) : "";
          const category = categoryFromCol || currentCategory || "";

          const price = col.price !== null ? row[col.price] : 0;
          const discountPrice = col.discountPrice !== null ? row[col.discountPrice] : 0;
          const quantity = col.quantity !== null ? row[col.quantity] : 0;
          const region = col.region !== null ? row[col.region] : "";

          const id = rawId ? `wine_${rawId}` : makeId();

          const wine = normalizeWine({
            id,
            category,
            name: rawName || "Без названия",
            region: normalizeText(region),
            price,
            discountPrice,
            quantity,
          });

          if (!wine.id) continue;
          wines.push(wine);
        }

        wines.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
        return wines;
      }

      function ToggleSwitch({ label, checked, onChange }) {
        return (
          <div className="flex items-center justify-between py-2">
            <span className="text-sm font-medium text-[var(--ink)] dark:text-gray-200">{label}</span>
            <button
              type="button"
              onClick={() => onChange(!checked)}
              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:ring-offset-2 ${
                checked ? "bg-[var(--brand)]" : "bg-gray-200 dark:bg-gray-700"
              }`}
              aria-pressed={checked}
            >
              <span
                className={`inline-block h-4 w-4 transform rounded-full bg-white transition duration-200 ease-in-out ${
                  checked ? "translate-x-6" : "translate-x-1"
                }`}
              />
            </button>
          </div>
        );
      }

      function UpdateModal({ wine, onClose, onSave }) {
        const [localQuantity, setLocalQuantity] = useState(safeNumber(wine?.quantity, 0));

        const increment = () => setLocalQuantity((prev) => prev + 1);
        const decrement = () => setLocalQuantity((prev) => Math.max(0, prev - 1));

        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in">
            <div className="relative w-full max-w-md overflow-hidden rounded-3xl bg-white shadow-2xl ring-1 ring-black/5 dark:bg-[#1c2e1f] dark:ring-white/10">
              <div className="relative z-10 p-8">
                <div className="flex items-center justify-between mb-6">
                  <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-[var(--brand)]/10 text-[var(--brand)] mb-2">
                    <span className="material-symbols-outlined text-2xl" aria-hidden="true">wine_bar</span>
                  </div>
                  <button
                    type="button"
                    onClick={onClose}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                    aria-label="Закрыть"
                  >
                    <span className="material-symbols-outlined" aria-hidden="true">close</span>
                  </button>
                </div>

                <h3 className="text-2xl font-black text-[var(--ink)] dark:text-white leading-tight mb-2">{wine.name}</h3>
                <p className="text-gray-500 dark:text-gray-400 text-sm font-medium uppercase tracking-wide mb-8">
                  Корректировка остатка
                </p>

                <div className="flex items-center justify-between bg-gray-50 dark:bg-[#131811]/50 rounded-2xl p-4 mb-8 border border-gray-100 dark:border-white/5">
                  <button
                    type="button"
                    onClick={decrement}
                    className="w-12 h-12 flex items-center justify-center rounded-xl bg-white dark:bg-[#1c2e1f] text-gray-600 dark:text-gray-300 shadow-sm border border-gray-100 dark:border-white/10 hover:bg-gray-50 hover:scale-105 active:scale-95 transition-all"
                    aria-label="Уменьшить"
                  >
                    <span className="material-symbols-outlined" aria-hidden="true">remove</span>
                  </button>

                  <div className="flex flex-col items-center">
                    <span className="text-4xl font-black text-[var(--ink)] dark:text-white tabular-nums">{localQuantity}</span>
                    <span className="text-xs font-medium text-gray-400 mt-1">бутылки</span>
                  </div>

                  <button
                    type="button"
                    onClick={increment}
                    className="w-12 h-12 flex items-center justify-center rounded-xl bg-white dark:bg-[#1c2e1f] text-[var(--brand)] shadow-sm border border-gray-100 dark:border-white/10 hover:bg-gray-50 hover:scale-105 active:scale-95 transition-all"
                    aria-label="Увеличить"
                  >
                    <span className="material-symbols-outlined" aria-hidden="true">add</span>
                  </button>
                </div>

                <button
                  type="button"
                  onClick={() => onSave(localQuantity)}
                  className="w-full flex items-center justify-center gap-2 rounded-xl h-14 bg-[var(--brand)] text-[var(--ink)] text-lg font-bold shadow-lg shadow-[var(--brand)]/25 hover:shadow-xl hover:-translate-y-0.5 hover:brightness-105 active:translate-y-0 active:shadow-md transition-all duration-300"
                >
                  <span>Подтвердить</span>
                  <span className="material-symbols-outlined" aria-hidden="true">check_circle</span>
                </button>
              </div>
            </div>
          </div>
        );
      }

      function HistoryModal({
        wines,
        onClose,
        isSupabaseReady,
        requireAuth,
        authUser,
        historySummaryByWineId,
        historySummaryLoading,
        historyOpenWineId,
        setHistoryOpenWineId,
        historyLoadingWineId,
        historyEventsByWineId,
        fetchWineEvents,
        formatDateTime,
      }) {
        const [query, setQuery] = useState("");
        const q = String(query || "").trim().toLowerCase();
        const list = useMemo(() => {
          const base = Array.isArray(wines) ? wines.slice() : [];
          base.sort((a, b) => String(a.name || "").localeCompare(String(b.name || "")));
          if (!q) return base;
          return base.filter((w) => String(w.name || "").toLowerCase().includes(q));
        }, [wines, q]);

        const canLoad = isSupabaseReady && (!requireAuth || authUser);

        function renderDeltaChip(wineId) {
          // Формат по вашему ТЗ:
          // продажа: -N красным, добавлена позиция: +N зеленым, если не было изменений: "нет изменений"
          if (historySummaryLoading) {
            return (
              <div className="px-2 py-1 rounded-full border border-gray-200 dark:border-white/10 bg-white/70 dark:bg-black/20 text-[10px] font-bold text-gray-500">
                ...
              </div>
            );
          }
          const s = historySummaryByWineId?.[wineId] || null;
          if (!s || !s.events_count) {
            return (
              <div className="px-2 py-1 rounded-full border border-gray-200 dark:border-white/10 bg-white/70 dark:bg-black/20 text-[10px] font-bold text-gray-500">
                нет изменений
              </div>
            );
          }

          const delta = Number(s.delta_sum || 0);
          if (delta < 0) {
            return (
              <div className="px-2 py-1 rounded-full border border-red-200 bg-red-50 text-[10px] font-black text-red-700 tabular-nums">
                {delta}
              </div>
            );
          }
          if (delta > 0) {
            return (
              <div className="px-2 py-1 rounded-full border border-emerald-200 bg-emerald-50 text-[10px] font-black text-emerald-700 tabular-nums">
                +{delta}
              </div>
            );
          }

          // События были, но суммарно 0
          return (
            <div className="px-2 py-1 rounded-full border border-gray-200 dark:border-white/10 bg-white/70 dark:bg-black/20 text-[10px] font-bold text-gray-600 tabular-nums">
              0
            </div>
          );
        }

        return (
          <div className="fixed inset-0 z-[120] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in">
            <div className="relative w-full max-w-2xl overflow-hidden rounded-3xl bg-white shadow-2xl ring-1 ring-black/5 dark:bg-[#1c2e1f] dark:ring-white/10">
              <div className="p-6 sm:p-8">
                <div className="flex items-start justify-between gap-3 mb-4">
                  <div>
                    <h3 className="text-2xl font-black text-[var(--ink)] dark:text-white leading-tight">История</h3>
                    <p className="text-gray-500 dark:text-gray-400 text-sm font-medium">
                      Показывает изменения количества. Если количество уменьшилось — это “продажа”.
                    </p>
                  </div>
                  <button
                    type="button"
                    onClick={onClose}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                    aria-label="Закрыть"
                  >
                    <span className="material-symbols-outlined" aria-hidden="true">
                      close
                    </span>
                  </button>
                </div>

                {!canLoad ? (
                  <div className="rounded-2xl border border-amber-300/50 bg-amber-50 p-4 text-sm text-amber-800 dark:bg-amber-900/20 dark:text-amber-200 dark:border-amber-700/40">
                    {isSupabaseReady ? (
                      <div>
                        Нужно войти (пароль) чтобы видеть историю.
                      </div>
                    ) : (
                      <div>Supabase не настроен — историю показать нельзя.</div>
                    )}
                  </div>
                ) : null}

                <div className="mt-4">
                  <div className="flex items-center gap-2 bg-white/60 dark:bg-white/10 border border-gray-200/70 dark:border-white/10 rounded-2xl px-4 h-12">
                    <span className="material-symbols-outlined text-gray-400" aria-hidden="true">
                      search
                    </span>
                    <input
                      className="w-full bg-transparent outline-none text-sm font-medium text-[var(--ink)] dark:text-white placeholder:text-gray-400"
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      placeholder="Найти позицию..."
                      aria-label="Поиск по названию"
                    />
                    {query ? (
                      <button
                        type="button"
                        onClick={() => setQuery("")}
                        className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                        aria-label="Очистить поиск"
                      >
                        <span className="material-symbols-outlined" aria-hidden="true">
                          close
                        </span>
                      </button>
                    ) : null}
                  </div>
                </div>

                <div className="mt-4 max-h-[60vh] overflow-y-auto no-scrollbar pr-1">
                  {list.length ? (
                    <div className="flex flex-col gap-3">
                      {list.map((w) => {
                        const isOpen = historyOpenWineId === w.id;
                        const events = historyEventsByWineId[w.id] || null;
                        const loading = historyLoadingWineId === w.id;

                        return (
                          <div key={w.id} className="rounded-2xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/10 p-4">
                            <button
                              type="button"
                              onClick={async () => {
                                const nextOpen = isOpen ? null : w.id;
                                setHistoryOpenWineId(nextOpen);
                                if (nextOpen) await fetchWineEvents(nextOpen);
                              }}
                              className="w-full flex items-start justify-between gap-3 text-left"
                            >
                              <div className="min-w-0">
                                <div className="font-bold text-[var(--ink)] dark:text-white break-words">{w.name}</div>
                                <div className="text-[10px] uppercase text-gray-500 dark:text-gray-400 break-words">{w.region}</div>
                              </div>
                              <div className="shrink-0 flex items-center gap-2">
                                {renderDeltaChip(w.id)}
                                <div className="px-2 py-1 rounded-lg border border-gray-200 dark:border-white/10 bg-white/70 dark:bg-black/20 text-xs font-black tabular-nums">
                                  {w.quantity}
                                </div>
                                <span className="material-symbols-outlined text-gray-500" aria-hidden="true">
                                  {isOpen ? "expand_less" : "expand_more"}
                                </span>
                              </div>
                            </button>

                            {isOpen ? (
                              <div className="mt-3">
                                {loading ? (
                                  <div className="text-xs text-gray-500">Загружаю историю...</div>
                                ) : events && events.length ? (
                                  <div className="flex flex-col gap-2">
                                    {events.map((ev) => {
                                      const sign = ev.delta > 0 ? "+" : "";
                                      const label =
                                        ev.event_type === "sale" ? "Продажа" : ev.event_type === "restock" ? "Поступление" : "Изменение";
                                      return (
                                        <div key={ev.id} className="rounded-xl border border-gray-200/60 dark:border-white/10 bg-white/70 dark:bg-black/20 p-3">
                                          <div className="flex items-center justify-between gap-3">
                                            <div className="text-xs font-black text-[var(--ink)] dark:text-white">
                                              {label}: {sign}
                                              {ev.delta}
                                            </div>
                                            <div className="text-[10px] text-gray-500">{formatDateTime(ev.created_at)}</div>
                                          </div>
                                          <div className="mt-1 text-[10px] text-gray-500">
                                            Было: <b>{ev.old_quantity}</b> → Стало: <b>{ev.new_quantity}</b>
                                            {ev.source ? ` • источник: ${ev.source}` : ""}
                                          </div>
                                        </div>
                                      );
                                    })}
                                  </div>
                                ) : (
                                  <div className="text-xs text-gray-500">
                                    Пока нет записей. Измените остаток — и событие появится здесь.
                                  </div>
                                )}
                              </div>
                            ) : null}
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-center text-sm text-gray-500 py-6">Ничего не найдено</div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [wines, setWines] = useState([]);
        const [loading, setLoading] = useState(true);

        // --- Supabase (облако) ---
        const supaRef = useRef(null);
        const saveTimerRef = useRef(null);
        const [syncStatus, setSyncStatus] = useState(isSupabaseConfigured() ? "Supabase: готов" : "Supabase: выключен");
        const [authUser, setAuthUser] = useState(null);
        // Email прячем (общий аккаунт), чтобы людям нужен был только пароль
        const [authUserEmail, setAuthUserEmail] = useState(SHARED_AUTH_EMAIL);
        const [authPassword, setAuthPassword] = useState("");
        const [authError, setAuthError] = useState("");

        const [selectedWine, setSelectedWine] = useState(null);
        const [isModalOpen, setIsModalOpen] = useState(false);

        const [isMenuOpen, setIsMenuOpen] = useState(false);
        const fileInputRef = useRef(null);

        const [showPrice, setShowPrice] = useState(true);
        const [showDiscount, setShowDiscount] = useState(true);
        const [showQuantity, setShowQuantity] = useState(true);

        const [isEditMode, setIsEditMode] = useState(false);

        // Фильтр по категории (null = показываем все)
        const [activeCategory, setActiveCategory] = useState(null);
        // Поиск по названию (в реальном времени)
        const [searchQuery, setSearchQuery] = useState("");

        // --- История изменений количества ---
        const [isHistoryOpen, setIsHistoryOpen] = useState(false);
        const [historyOpenWineId, setHistoryOpenWineId] = useState(null);
        const [historyLoadingWineId, setHistoryLoadingWineId] = useState(null);
        const [historyEventsByWineId, setHistoryEventsByWineId] = useState({}); // { [wineId]: events[] }
        const [historySummaryByWineId, setHistorySummaryByWineId] = useState({}); // { [wineId]: { events_count, delta_sum } }
        const [historySummaryLoading, setHistorySummaryLoading] = useState(false);

        function formatDateTime(value) {
          try {
            return new Intl.DateTimeFormat("ru-RU", { dateStyle: "short", timeStyle: "short" }).format(new Date(value));
          } catch (_) {
            return String(value || "");
          }
        }

        async function logQuantityEvent({ wineId, oldQuantity, newQuantity, source }) {
          const supa = supaRef.current;
          if (!supa) return;
          if (SUPABASE_REQUIRE_AUTH && !authUser) return;
          if (!wineId) return;

          const oldQ = Math.max(0, Math.floor(safeNumber(oldQuantity, 0)));
          const newQ = Math.max(0, Math.floor(safeNumber(newQuantity, 0)));
          if (oldQ === newQ) return;

          const delta = newQ - oldQ;
          const eventType = delta < 0 ? "sale" : delta > 0 ? "restock" : "adjust";

          try {
            const { error } = await supa.from("wine_events").insert([
              {
                wine_id: String(wineId),
                event_type: eventType,
                delta,
                old_quantity: oldQ,
                new_quantity: newQ,
                source: String(source || ""),
                actor: String(authUser?.email || ""),
              },
            ]);
            if (error) throw error;
          } catch (e) {
            console.warn("wine_events insert error:", e);
          }
        }

        async function fetchWineEvents(wineId) {
          const supa = supaRef.current;
          if (!supa) return;
          if (SUPABASE_REQUIRE_AUTH && !authUser) return;
          if (!wineId) return;

          // Уже загружали — не трогаем
          if (historyEventsByWineId[wineId]) return;

          setHistoryLoadingWineId(wineId);
          try {
            const { data, error } = await supa
              .from("wine_events")
              .select("id, wine_id, event_type, delta, old_quantity, new_quantity, source, actor, created_at")
              .eq("wine_id", wineId)
              .order("created_at", { ascending: false })
              .limit(50);
            if (error) throw error;
            setHistoryEventsByWineId((prev) => ({ ...prev, [wineId]: data || [] }));
          } catch (e) {
            console.warn("wine_events load error:", e);
            setHistoryEventsByWineId((prev) => ({ ...prev, [wineId]: [] }));
          } finally {
            setHistoryLoadingWineId(null);
          }
        }

        async function fetchHistorySummary() {
          const supa = supaRef.current;
          if (!supa) return;
          if (SUPABASE_REQUIRE_AUTH && !authUser) return;
          setHistorySummaryLoading(true);
          try {
            const { data, error } = await supa.from("wine_event_summary").select("wine_id, events_count, delta_sum");
            if (error) throw error;
            const map = {};
            (data || []).forEach((row) => {
              map[row.wine_id] = {
                events_count: Number(row.events_count || 0),
                delta_sum: Number(row.delta_sum || 0),
              };
            });
            setHistorySummaryByWineId(map);
          } catch (e) {
            console.warn("wine_event_summary load error:", e);
            setHistorySummaryByWineId({});
          } finally {
            setHistorySummaryLoading(false);
          }
        }

        async function loadFromSupabase() {
          const supa = supaRef.current;
          if (!supa) return null;
          try {
            setSyncStatus("Supabase: загружаю...");
            const { data, error } = await supa
              .from("wines")
              .select("id, category, name, region, price, discount_price, quantity")
              .order("name", { ascending: true });
            if (error) throw error;
            const normalized = (data || []).map((row) =>
              normalizeWine({
                id: row.id,
                category: row.category,
                name: row.name,
                region: row.region,
                price: row.price,
                discountPrice: row.discount_price,
                quantity: row.quantity,
              })
            );
            setSyncStatus(`Supabase: загружено ${normalized.length}`);
            return normalized;
          } catch (e) {
            console.warn("Supabase load error:", e);
            setSyncStatus("Supabase: ошибка загрузки");
            return null;
          }
        }

        async function saveToSupabase(nextWines) {
          const supa = supaRef.current;
          if (!supa) return;
          if (SUPABASE_REQUIRE_AUTH && !authUser) return;
          try {
            setSyncStatus("Supabase: сохраняю...");
            const payload = (nextWines || []).map((w) => ({
              id: String(w.id),
              category: String(w.category || ""),
              name: String(w.name || ""),
              region: String(w.region || ""),
              price: safeNumber(w.price, 0),
              discount_price: safeNumber(w.discountPrice, 0),
              quantity: Math.max(0, Math.floor(safeNumber(w.quantity, 0))),
            }));
            // **upsert**: “вставить или обновить по ключу”
            const { error } = await supa.from("wines").upsert(payload, { onConflict: "id" });
            if (error) throw error;
            setSyncStatus(`Supabase: сохранено ${payload.length}`);
          } catch (e) {
            console.warn("Supabase save error:", e);
            setSyncStatus("Supabase: ошибка сохранения");
          }
        }

        async function signIn() {
          const supa = supaRef.current;
          if (!supa) return;
          setAuthError("");
          try {
            setSyncStatus("Supabase: логин...");
            const { data, error } = await supa.auth.signInWithPassword({
              // Берём общий email, чтобы пользователю был нужен только пароль
              email: String(SHARED_AUTH_EMAIL || authUserEmail || "").trim(),
              password: String(authPassword || ""),
            });
            if (error) throw error;
            setAuthUser(data?.user ?? null);
            setSyncStatus("Supabase: вы вошли");
          } catch (e) {
            console.warn("Supabase auth error:", e);
            setAuthError("Не удалось войти. Проверьте email/пароль и настройки Auth в Supabase.");
            setSyncStatus("Supabase: не вошли");
          }
        }

        async function signOut() {
          const supa = supaRef.current;
          if (!supa) return;
          setAuthError("");
          try {
            await supa.auth.signOut();
            setAuthUser(null);
            setSyncStatus("Supabase: вышли");
          } catch (e) {
            console.warn("Supabase signOut error:", e);
          }
        }

        async function loadLocalOrExcel() {
          const stored = loadFromStorage();
          if (stored && stored.length) {
            const initial = stored.map(normalizeWine);
            initial.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            return initial;
          }

          // Если localStorage пустой — пробуем авто-загрузку локального Excel файла
          const defaultXlsxUrl = encodeURI("./Допродаем вина (1).xlsx");
          try {
            const res = await fetch(defaultXlsxUrl, { cache: "no-store" });
            if (!res.ok) throw new Error(`Не удалось скачать Excel (HTTP ${res.status})`);
            const buf = await res.arrayBuffer();
            const imported = parseExcelToWines(buf);
            if (imported.length) return imported;
          } catch (e) {
            console.warn("Авто-загрузка Excel не сработала:", e);
          }

          const fallback = INITIAL_WINES.slice().map(normalizeWine);
          fallback.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
          return fallback;
        }

        // Загружаем данные один раз при старте
        useEffect(() => {
          supaRef.current = createSupabaseClient();
          const supa = supaRef.current;
          let unsubscribe = null;

          (async () => {
            let sessionUser = null;

            if (supa) {
              try {
                const { data } = await supa.auth.getSession();
                sessionUser = data?.session?.user ?? null;
                setAuthUser(sessionUser);

                const { data: sub } = supa.auth.onAuthStateChange((_event, session) => {
                  setAuthUser(session?.user ?? null);
                });
                unsubscribe = () => sub?.subscription?.unsubscribe?.();
              } catch (e) {
                console.warn("Supabase getSession error:", e);
              }

              if (SUPABASE_REQUIRE_AUTH && !sessionUser) {
                setSyncStatus("Supabase: нужен логин");
              } else {
                const cloud = await loadFromSupabase();
                if (cloud && cloud.length) {
                  setWines(cloud);
                  setLoading(false);
                  return;
                }
              }
            }

            const local = await loadLocalOrExcel();
            setWines(local);
            setLoading(false);

            // Если в облаке пусто — “засеем” его локальными данными (только когда можно писать)
            if (supa && (!SUPABASE_REQUIRE_AUTH || sessionUser)) {
              await saveToSupabase(local);
            }
          })();

          return () => {
            if (typeof unsubscribe === "function") unsubscribe();
          };
        }, []);

        // Автосохранение
        useEffect(() => {
          if (!loading) saveToStorage(wines);
        }, [wines, loading]);

        // Если пользователь залогинился позже — пробуем подтянуть облачные данные
        useEffect(() => {
          if (!supaRef.current) return;
          if (!SUPABASE_REQUIRE_AUTH) return;
          if (!authUser) return;

          (async () => {
            const cloud = await loadFromSupabase();
            if (cloud && cloud.length) {
              setWines(cloud);
              return;
            }
            // Если в облаке пусто — отправим текущие данные
            await saveToSupabase(wines);
          })();
        }, [authUser]);

        // Автосохранение в Supabase (с задержкой, чтобы не спамить сеть)
        useEffect(() => {
          if (loading) return;
          if (!supaRef.current) return;
          if (SUPABASE_REQUIRE_AUTH && !authUser) return;

          if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
          saveTimerRef.current = setTimeout(() => {
            saveToSupabase(wines);
          }, 600);

          return () => {
            if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
          };
        }, [wines, loading, authUser]);

        const openEditModal = (wine) => {
          setSelectedWine(wine);
          setIsModalOpen(true);
        };

        const closeEditModal = () => {
          setIsModalOpen(false);
          setTimeout(() => setSelectedWine(null), 150);
        };

        const handleUpdateQuantity = (newQuantity) => {
          if (!selectedWine) return;
          const q = Math.max(0, Math.floor(safeNumber(newQuantity, selectedWine.quantity || 0)));
          const oldQ = Math.max(0, Math.floor(safeNumber(selectedWine.quantity, 0)));
          setWines((prev) => {
            const next = prev.map((w) => (w.id === selectedWine.id ? { ...w, quantity: q } : w));
            next.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            return next;
          });
          // Пишем событие “продажа/поступление” только при изменении количества
          logQuantityEvent({ wineId: selectedWine.id, oldQuantity: oldQ, newQuantity: q, source: "modal" });
          closeEditModal();
        };

        // Inline-редактирование по onBlur (когда поле теряет фокус)
        const handleInlineUpdate = (id, field, value) => {
          // Если меняем количество — запомним старое значение ДО setWines
          const currentWine = wines.find((w) => w.id === id);
          const oldQ = field === "quantity" ? Math.max(0, Math.floor(safeNumber(currentWine?.quantity, 0))) : null;
          const newQ = field === "quantity" ? Math.max(0, Math.floor(safeNumber(value, 0))) : null;

          setWines((prev) => {
            const next = prev.map((w) => {
              if (w.id !== id) return w;
              if (field === "price" || field === "discountPrice") return { ...w, [field]: safeNumber(value, 0) };
              if (field === "quantity") return { ...w, quantity: Math.max(0, Math.floor(safeNumber(value, 0))) };
              if (field === "category") return { ...w, category: normalizeCategory(value) };
              if (field === "name" || field === "region") return { ...w, [field]: String(value ?? "") };
              return w;
            });
            next.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            return next;
          });

          if (field === "quantity" && currentWine) {
            logQuantityEvent({ wineId: id, oldQuantity: oldQ, newQuantity: newQ, source: "inline" });
          }
        };

        // Excel export
        const handleExport = () => {
          if (!window.XLSX) {
            alert("Excel-библиотека еще загружается. Подождите пару секунд и попробуйте снова.");
            return;
          }

          const dataToExport = wines.map((w) => ({
            "ID (Не менять)": w.id,
            Категория: w.category,
            Наименование: w.name,
            Регион: w.region,
            "Цена (₽)": safeNumber(w.price, 0),
            "Цена со скидкой (₽)": safeNumber(w.discountPrice, 0),
            Количество: safeNumber(w.quantity, 0),
          }));

          const worksheet = window.XLSX.utils.json_to_sheet(dataToExport);
          const workbook = window.XLSX.utils.book_new();
          window.XLSX.utils.book_append_sheet(workbook, worksheet, "Остатки");
          window.XLSX.writeFile(workbook, "SaborDeLaVida_Wine.xlsx");
        };

        // Excel import
        const triggerFileInput = () => {
          if (fileInputRef.current) fileInputRef.current.click();
        };

        const handleImport = (e) => {
          if (!window.XLSX) return;
          const file = e.target.files && e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = evt.target.result;
              const imported = parseExcelToWines(data);
              if (!imported.length) {
                alert("Файл пуст или имеет неверный формат.");
                return;
              }
              setWines(imported);
              setIsMenuOpen(false);
              alert(`Успешно загружено ${imported.length} позиций.`);
            } catch (error) {
              console.error("Import error:", error);
              alert("Ошибка при обработке файла. Убедитесь, что это корректный Excel файл.");
            } finally {
              if (fileInputRef.current) fileInputRef.current.value = "";
            }
          };
          reader.readAsArrayBuffer(file);
        };

        const normalizedSearch = useMemo(() => String(searchQuery || "").trim().toLowerCase(), [searchQuery]);

        const filteredWines = useMemo(() => {
          const byCategory = activeCategory ? wines.filter((w) => w.category === activeCategory) : wines;
          if (!normalizedSearch) return byCategory;
          return byCategory.filter((w) => String(w.name || "").toLowerCase().includes(normalizedSearch));
        }, [wines, activeCategory, normalizedSearch]);

        return (
          <div className="bg-[var(--bg)] dark:bg-[#162111] text-[var(--ink)] dark:text-white overflow-x-hidden transition-colors duration-300 relative min-h-screen">
            {/* Фон */}
            <div className="fixed inset-0 z-0 w-full h-full" aria-hidden="true">
              <div className="absolute inset-0 bg-black/10 z-10"></div>
              <img
                alt=""
                className="w-full h-full object-cover"
                src="images/wine-liquidation-list-background.jpg"
              />
            </div>

            <input type="file" accept=".xlsx,.xls" ref={fileInputRef} onChange={handleImport} className="hidden" />

            <div className="relative z-10 flex min-h-screen flex-col">
              <header className="glass-panel sticky top-0 z-40 border-b border-[#f2f4f0]/20 px-4 lg:px-10 py-3 shadow-sm">
                <div className="mx-auto max-w-7xl flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="size-8 flex items-center justify-center rounded-full bg-[var(--brand)]/10 text-[var(--brand)]">
                      <span className="material-symbols-outlined text-2xl" aria-hidden="true">wine_bar</span>
                    </div>
                    <h2 className="text-[var(--ink)] dark:text-white text-xl font-bold leading-tight tracking-tight">Sabor de la Vida</h2>
                  </div>

                  <button
                    type="button"
                    onClick={() => setIsMenuOpen(true)}
                    className="p-1 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
                    aria-label="Открыть меню"
                  >
                    <span className="material-symbols-outlined text-2xl cursor-pointer" aria-hidden="true">menu</span>
                  </button>
                </div>
              </header>

              <main className="flex-grow flex items-center justify-center py-8 px-2 sm:px-6">
                <div className="w-full max-w-6xl mx-auto">
                  <div className="glass-panel rounded-3xl shadow-2xl overflow-hidden p-6 sm:p-8 lg:p-10">
                    <div className="flex flex-col items-center text-center mb-6">
                      {isEditMode ? (
                        <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-amber-500/10 text-amber-600 text-xs font-bold uppercase tracking-wider mb-3 border border-amber-500/20 animate-pulse">
                          <span className="material-symbols-outlined text-sm" aria-hidden="true">edit</span>
                          Режим редактирования
                        </div>
                      ) : (
                        <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[var(--brand)]/10 text-[var(--brand)] text-xs font-bold uppercase tracking-wider mb-3 border border-[var(--brand)]/20">
                          <span className="material-symbols-outlined text-sm" aria-hidden="true">verified</span>
                          Учет остатков винных позиций
                        </div>
                      )}
                      <h1 className="text-[var(--ink)] dark:text-white text-3xl sm:text-4xl md:text-5xl font-black leading-tight tracking-tight mb-3">
                        Вино в Sabor de la Vida
                      </h1>
                    </div>

                    {/* Вкладки категорий + поиск */}
                    <div className="flex flex-col gap-3 sm:gap-4 mb-6">
                      <div className="flex items-center justify-between gap-3">
                        <div className="flex-1 overflow-x-auto no-scrollbar">
                          <div className="inline-flex gap-2">
                            {WINE_CATEGORIES.map((cat) => {
                              const active = activeCategory === cat;
                              return (
                                <button
                                  key={cat}
                                  type="button"
                                  onClick={() => setActiveCategory((prev) => (prev === cat ? null : cat))}
                                  className={`px-3 py-2 rounded-full text-xs sm:text-sm font-bold uppercase tracking-wider border transition-colors ${
                                    active
                                      ? "bg-[var(--brand)] text-[var(--ink)] border-[var(--brand)]"
                                      : "bg-white/60 dark:bg-white/10 text-gray-700 dark:text-gray-200 border-gray-200/70 dark:border-white/10 hover:border-[var(--brand)]"
                                  }`}
                                  aria-pressed={active}
                                >
                                  {cat}
                                </button>
                              );
                            })}
                          </div>
                        </div>

                        {activeCategory && (
                          <button
                            type="button"
                            onClick={() => setActiveCategory(null)}
                            className="shrink-0 text-xs font-bold text-gray-600 dark:text-gray-300 hover:text-[var(--brand)] transition-colors"
                            title="Показать все категории"
                          >
                            Сбросить
                          </button>
                        )}
                      </div>

                      <div className="w-full">
                        <div className="flex items-center gap-2 bg-white/60 dark:bg-white/10 border border-gray-200/70 dark:border-white/10 rounded-2xl px-4 h-12">
                          <span className="material-symbols-outlined text-gray-400" aria-hidden="true">search</span>
                          <input
                            className="w-full bg-transparent outline-none text-sm font-medium text-[var(--ink)] dark:text-white placeholder:text-gray-400"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="Поиск по названию..."
                            aria-label="Поиск по названию"
                          />
                          {searchQuery ? (
                            <button
                              type="button"
                              onClick={() => setSearchQuery("")}
                              className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                              aria-label="Очистить поиск"
                            >
                              <span className="material-symbols-outlined" aria-hidden="true">close</span>
                            </button>
                          ) : null}
                        </div>
                      </div>
                    </div>

                    {/* Телефон: карточки (без горизонтального скролла) */}
                    <div className="sm:hidden">
                      {loading ? (
                        <div className="flex justify-center py-10">
                          <span className="material-symbols-outlined animate-spin text-4xl text-[var(--brand)]" aria-hidden="true">
                            refresh
                          </span>
                        </div>
                      ) : filteredWines.length ? (
                        <div className="flex flex-col gap-3">
                          {filteredWines.map((wine) => (
                            <div
                              key={wine.id}
                              className="rounded-2xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/10 p-4"
                            >
                              <div className="flex items-start justify-between gap-3">
                                <div className="min-w-0">
                                  {isEditMode ? (
                                    <>
                                      <input
                                        className="edit-input font-bold text-[var(--ink)] dark:text-white mb-1"
                                        defaultValue={wine.name}
                                        onBlur={(e) => handleInlineUpdate(wine.id, "name", e.target.value)}
                                      />
                                      <input
                                        className="edit-input text-[10px] uppercase text-gray-500 dark:text-gray-400"
                                        defaultValue={wine.region}
                                        onBlur={(e) => handleInlineUpdate(wine.id, "region", e.target.value)}
                                      />
                                      <select
                                        className="edit-input text-xs font-bold uppercase tracking-wider text-gray-600 dark:text-gray-200"
                                        defaultValue={wine.category || ""}
                                        onChange={(e) => handleInlineUpdate(wine.id, "category", e.target.value)}
                                        aria-label="Категория вина"
                                      >
                                        <option value="">(без категории)</option>
                                        {WINE_CATEGORIES.map((c) => (
                                          <option key={c} value={c}>
                                            {c}
                                          </option>
                                        ))}
                                      </select>
                                    </>
                                  ) : (
                                    <>
                                      <div className="font-black text-[var(--ink)] dark:text-white leading-tight break-words">{wine.name}</div>
                                      <div className="text-[10px] uppercase text-gray-500 dark:text-gray-400 break-words">{wine.region}</div>
                                      {wine.category ? (
                                        <div className="mt-2 inline-flex items-center px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
                                          {wine.category}
                                        </div>
                                      ) : null}
                                    </>
                                  )}
                                </div>

                                {!isEditMode ? (
                                  <div className="shrink-0 flex flex-col items-end gap-2">
                                    <div className="w-16 h-9 flex items-center justify-center rounded-lg border border-gray-200 dark:bg-white/10 dark:border-white/20 bg-white/50 text-sm font-black text-[var(--ink)] dark:text-white">
                                      {wine.quantity}
                                    </div>
                                    <button
                                      type="button"
                                      onClick={() => openEditModal(wine)}
                                      className="h-9 px-3 rounded-lg bg-gray-100 hover:bg-[var(--brand)] hover:text-white transition-all text-[10px] font-bold uppercase tracking-wider"
                                    >
                                      Остаток
                                    </button>
                                  </div>
                                ) : null}
                              </div>

                              <div className="mt-4 grid grid-cols-2 gap-3">
                                {showPrice ? (
                                  <div className="rounded-xl bg-white/60 dark:bg-black/20 border border-gray-200/60 dark:border-white/10 p-3">
                                    <div className="text-[10px] font-bold uppercase tracking-widest text-gray-500">Цена</div>
                                    {isEditMode ? (
                                      <input
                                        type="number"
                                        className="edit-input mt-1"
                                        defaultValue={wine.price}
                                        onBlur={(e) => handleInlineUpdate(wine.id, "price", e.target.value)}
                                      />
                                    ) : (
                                      <div className="mt-1 font-bold text-[var(--ink)] dark:text-white">{formatRub(wine.price)} ₽</div>
                                    )}
                                  </div>
                                ) : null}

                                {showDiscount ? (
                                  <div className="rounded-xl bg-white/60 dark:bg-black/20 border border-gray-200/60 dark:border-white/10 p-3">
                                    <div className="text-[10px] font-bold uppercase tracking-widest text-gray-500">Со скидкой</div>
                                    {isEditMode ? (
                                      <input
                                        type="number"
                                        className="edit-input mt-1 text-[var(--brand)]"
                                        defaultValue={wine.discountPrice}
                                        onBlur={(e) => handleInlineUpdate(wine.id, "discountPrice", e.target.value)}
                                      />
                                    ) : (
                                      <div className="mt-1 font-black text-[var(--brand)]">{formatRub(wine.discountPrice)} ₽</div>
                                    )}
                                  </div>
                                ) : null}

                                {showQuantity && isEditMode ? (
                                  <div className="col-span-2 rounded-xl bg-white/60 dark:bg-black/20 border border-gray-200/60 dark:border-white/10 p-3">
                                    <div className="text-[10px] font-bold uppercase tracking-widest text-gray-500">Остаток (бутылок)</div>
                                    <input
                                      type="number"
                                      className="edit-input mt-1 text-center font-black"
                                      defaultValue={wine.quantity}
                                      onBlur={(e) => handleInlineUpdate(wine.id, "quantity", e.target.value)}
                                    />
                                  </div>
                                ) : null}
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="text-center text-sm text-gray-500 py-8">Пока нет позиций</div>
                      )}
                    </div>

                    {/* Компьютер: таблица */}
                    <div className="hidden sm:block overflow-x-auto no-scrollbar">
                      {loading ? (
                        <div className="flex justify-center py-10">
                          <span className="material-symbols-outlined animate-spin text-4xl text-[var(--brand)]" aria-hidden="true">
                            refresh
                          </span>
                        </div>
                      ) : (
                        <table className="min-w-full text-left">
                          <thead>
                            <tr className="text-gray-500 dark:text-gray-400 text-[10px] sm:text-xs font-bold uppercase tracking-widest">
                              <th className="pb-4 pl-4">Наименование</th>
                              {showPrice && <th className="pb-4">Цена (₽)</th>}
                              {showDiscount && <th className="pb-4">Цена со скидкой (₽)</th>}
                              {showQuantity && <th className="pb-4 pr-4">Остаток (бутылок)</th>}
                            </tr>
                          </thead>
                          <tbody>
                            {filteredWines.map((wine) => (
                              <tr key={wine.id} className="group hover:bg-white/40 dark:hover:bg-white/5 transition-colors">
                                <td className="py-4 pl-4 rounded-l-xl">
                                  <div className="flex flex-col">
                                    {isEditMode ? (
                                      <>
                                        <input
                                          className="edit-input font-bold text-[var(--ink)] dark:text-white mb-1"
                                          defaultValue={wine.name}
                                          onBlur={(e) => handleInlineUpdate(wine.id, "name", e.target.value)}
                                        />
                                        <input
                                          className="edit-input text-[10px] uppercase text-gray-500 dark:text-gray-400"
                                          defaultValue={wine.region}
                                          onBlur={(e) => handleInlineUpdate(wine.id, "region", e.target.value)}
                                        />
                                        <select
                                          className="edit-input text-xs font-bold uppercase tracking-wider text-gray-600 dark:text-gray-200"
                                          defaultValue={wine.category || ""}
                                          onChange={(e) => handleInlineUpdate(wine.id, "category", e.target.value)}
                                          aria-label="Категория вина"
                                        >
                                          <option value="">(без категории)</option>
                                          {WINE_CATEGORIES.map((c) => (
                                            <option key={c} value={c}>
                                              {c}
                                            </option>
                                          ))}
                                        </select>
                                      </>
                                    ) : (
                                      <>
                                        <span className="text-[var(--ink)] dark:text-white font-bold">{wine.name}</span>
                                        <span className="text-gray-500 dark:text-gray-400 text-[10px] uppercase">{wine.region}</span>
                                      </>
                                    )}
                                  </div>
                                </td>

                                {showPrice && (
                                  <td className="py-4 text-[var(--ink)] dark:text-white font-medium align-middle">
                                    {isEditMode ? (
                                      <div className="flex items-center">
                                        <input
                                          type="number"
                                          className="edit-input w-24"
                                          defaultValue={wine.price}
                                          onBlur={(e) => handleInlineUpdate(wine.id, "price", e.target.value)}
                                        />
                                      </div>
                                    ) : (
                                      formatRub(wine.price)
                                    )}
                                  </td>
                                )}

                                {showDiscount && (
                                  <td className="py-4 text-[var(--brand)] font-bold align-middle">
                                    {isEditMode ? (
                                      <div className="flex items-center">
                                        <input
                                          type="number"
                                          className="edit-input w-24 text-[var(--brand)]"
                                          defaultValue={wine.discountPrice}
                                          onBlur={(e) => handleInlineUpdate(wine.id, "discountPrice", e.target.value)}
                                        />
                                      </div>
                                    ) : (
                                      formatRub(wine.discountPrice)
                                    )}
                                  </td>
                                )}

                                {showQuantity && (
                                  <td className="py-4 pr-4 rounded-r-xl align-middle">
                                    {isEditMode ? (
                                      <input
                                        type="number"
                                        className="edit-input w-full text-center font-bold bg-white/50 dark:bg-black/20 rounded-lg h-9 border-gray-200"
                                        defaultValue={wine.quantity}
                                        onBlur={(e) => handleInlineUpdate(wine.id, "quantity", e.target.value)}
                                      />
                                    ) : (
                                      <div className="flex items-center gap-2">
                                        <div className="w-16 h-9 flex items-center justify-center rounded-lg border border-gray-200 dark:bg-white/10 dark:border-white/20 bg-white/50 text-sm font-bold text-[var(--ink)] dark:text-white">
                                          {wine.quantity}
                                        </div>
                                        <button
                                          type="button"
                                          onClick={() => openEditModal(wine)}
                                          className="flex items-center justify-center h-9 px-3 rounded-lg bg-gray-100 hover:bg-[var(--brand)] hover:text-white transition-all text-[10px] font-bold uppercase tracking-wider"
                                        >
                                          Редактировать
                                        </button>
                                      </div>
                                    )}
                                  </td>
                                )}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      )}
                    </div>
                  </div>
                </div>
              </main>

              <footer className="relative z-10 glass-panel border-t border-[#f2f4f0]/20 py-6">
                <div className="mx-auto max-w-7xl px-10 flex items-center justify-center text-center">
                  <p className="text-xs font-medium text-gray-600 dark:text-gray-300">© 2026 Sabor de la Vida.</p>
                </div>
              </footer>
            </div>

            {/* Боковое меню */}
            {isMenuOpen && (
              <div className="fixed inset-0 z-[100] flex justify-end">
                <div
                  className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-fade-in"
                  onClick={() => setIsMenuOpen(false)}
                ></div>

                <div className="relative z-10 w-full max-w-xs h-full glass-sidebar shadow-2xl p-6 animate-slide-in flex flex-col overflow-y-auto">
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-xl font-bold text-[var(--ink)] dark:text-white">Меню</h3>
                    <button
                      type="button"
                      onClick={() => setIsMenuOpen(false)}
                      className="size-8 flex items-center justify-center rounded-full bg-black/5 hover:bg-black/10 dark:bg-white/5 dark:hover:bg-white/10 transition-colors"
                      aria-label="Закрыть меню"
                    >
                      <span className="material-symbols-outlined" aria-hidden="true">close</span>
                    </button>
                  </div>

                  <div className="mb-6">
                    <h4 className="text-xs font-bold text-gray-500 uppercase tracking-widest px-1 mb-3">Отображение</h4>
                    <div className="px-2">
                      <ToggleSwitch label="Цена" checked={showPrice} onChange={setShowPrice} />
                      <ToggleSwitch label="Цена со скидкой" checked={showDiscount} onChange={setShowDiscount} />
                      <ToggleSwitch label="Остатки" checked={showQuantity} onChange={setShowQuantity} />
                    </div>
                  </div>

                  <div className="h-px bg-gray-200 dark:bg-white/10 w-full mb-6"></div>

                  {/* Supabase: статус и логин */}
                  <div className="mb-6">
                    <h4 className="text-xs font-bold text-gray-500 uppercase tracking-widest px-1 mb-3">Синхронизация</h4>
                    <div className="bg-white/70 dark:bg-white/10 border border-gray-200/70 dark:border-white/10 rounded-2xl p-4">
                      <div className="text-xs font-bold text-gray-700 dark:text-gray-200 mb-2">{syncStatus}</div>

                      {!isSupabaseConfigured() ? (
                        <div className="text-[10px] text-gray-500">
                          Supabase выключен: вставьте `SUPABASE_URL` и `SUPABASE_ANON_KEY` вверху файла.
                        </div>
                      ) : SUPABASE_REQUIRE_AUTH ? (
                        authUser ? (
                          <div className="flex items-center justify-between gap-2">
                            <div className="text-[10px] text-gray-500 break-all">Вы вошли: {authUser.email}</div>
                            <button
                              type="button"
                              onClick={signOut}
                              className="shrink-0 text-[10px] font-bold px-3 py-2 rounded-xl border border-gray-200 hover:border-red-300 bg-white dark:bg-[#131811] transition-colors"
                            >
                              Выйти
                            </button>
                          </div>
                        ) : (
                          <div className="flex flex-col gap-2">
                            <div className="text-[10px] text-gray-500">
                              Введите общий пароль (email скрыт).
                            </div>
                            <input
                              className="edit-input text-xs"
                              placeholder="Пароль"
                              type="password"
                              value={authPassword}
                              onChange={(e) => setAuthPassword(e.target.value)}
                            />
                            {authError ? <div className="text-[10px] text-red-600">{authError}</div> : null}
                            <button
                              type="button"
                              onClick={signIn}
                              className="w-full flex items-center justify-center gap-2 rounded-xl h-10 bg-[var(--brand)] text-[var(--ink)] text-sm font-bold shadow"
                            >
                              Войти
                            </button>
                          </div>
                        )
                      ) : (
                        <div className="text-[10px] text-amber-700">
                          Включен режим без логина. Это небезопасно для публичного сайта.
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="flex flex-col gap-3">
                    <h4 className="text-xs font-bold text-gray-500 uppercase tracking-widest px-1">Действия</h4>

                    <button
                      type="button"
                      onClick={() => {
                        setIsEditMode(!isEditMode);
                        setIsMenuOpen(false);
                      }}
                      className={`flex items-center gap-3 w-full px-4 py-3 rounded-xl border shadow-sm transition-all text-left group ${
                        isEditMode
                          ? "bg-amber-50 border-amber-200 dark:bg-amber-900/20 dark:border-amber-700/50"
                          : "bg-white dark:bg-[#131811] border-gray-200 dark:border-white/10 hover:shadow-md hover:border-[var(--brand)]"
                      }`}
                    >
                      <div
                        className={`size-10 flex items-center justify-center rounded-lg transition-colors ${
                          isEditMode ? "bg-amber-100 text-amber-600" : "bg-gray-50 text-gray-600 group-hover:bg-[var(--brand)] group-hover:text-white"
                        }`}
                      >
                        <span className="material-symbols-outlined" aria-hidden="true">edit_note</span>
                      </div>
                      <div>
                        <span className="block text-sm font-bold text-[var(--ink)] dark:text-white">
                          {isEditMode ? "Выключить ред." : "Режим редактирования"}
                        </span>
                        <span className="block text-[10px] text-gray-500">{isEditMode ? "Нажмите для выхода" : "Ручное изменение полей"}</span>
                      </div>
                    </button>

                    <button
                      type="button"
                      onClick={triggerFileInput}
                      className="flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-white dark:bg-[#131811] border border-gray-200 dark:border-white/10 shadow-sm hover:shadow-md hover:border-[var(--brand)] transition-all text-left group"
                    >
                      <div className="size-10 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 group-hover:bg-[var(--brand)] group-hover:text-white transition-colors">
                        <span className="material-symbols-outlined" aria-hidden="true">upload_file</span>
                      </div>
                      <div>
                        <span className="block text-sm font-bold text-[var(--ink)] dark:text-white">Загрузить Excel</span>
                        <span className="block text-[10px] text-gray-500">Импорт списка</span>
                      </div>
                    </button>

                    <button
                      type="button"
                      onClick={handleExport}
                      className="flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-white dark:bg-[#131811] border border-gray-200 dark:border-white/10 shadow-sm hover:shadow-md hover:border-[var(--brand)] transition-all text-left group"
                    >
                      <div className="size-10 flex items-center justify-center rounded-lg bg-green-50 text-green-600 group-hover:bg-[var(--brand)] group-hover:text-white transition-colors">
                        <span className="material-symbols-outlined" aria-hidden="true">download</span>
                      </div>
                      <div>
                        <span className="block text-sm font-bold text-[var(--ink)] dark:text-white">Скачать Excel</span>
                        <span className="block text-[10px] text-gray-500">Экспорт списка</span>
                      </div>
                    </button>

                    <button
                      type="button"
                      onClick={() => {
                        setIsHistoryOpen(true);
                        // Подгружаем “индикаторы” сразу для всех позиций
                        fetchHistorySummary();
                        setIsMenuOpen(false);
                      }}
                      className="flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-white dark:bg-[#131811] border border-gray-200 dark:border-white/10 shadow-sm hover:shadow-md hover:border-red-300 transition-all text-left group"
                    >
                      <div className="size-10 flex items-center justify-center rounded-lg bg-purple-50 text-purple-700 group-hover:bg-purple-700 group-hover:text-white transition-colors">
                        <span className="material-symbols-outlined" aria-hidden="true">history</span>
                      </div>
                      <div>
                        <span className="block text-sm font-bold text-[var(--ink)] dark:text-white">История</span>
                        <span className="block text-[10px] text-gray-500">Проверка продаж и изменений</span>
                      </div>
                    </button>
                  </div>

                  <div className="mt-auto pt-6 text-center">
                    <p className="text-[10px] text-gray-400">Sabor de la Vida v1.0 (local)</p>
                  </div>
                </div>
              </div>
            )}

            {/* Модалка редактирования (только если НЕ включен глобальный режим ред.) */}
            {isModalOpen && selectedWine && !isEditMode && (
              <UpdateModal wine={selectedWine} onClose={closeEditModal} onSave={handleUpdateQuantity} />
            )}

            {/* История (проверка продаж/изменений) */}
            {isHistoryOpen && (
              <HistoryModal
                wines={wines}
                onClose={() => {
                  setIsHistoryOpen(false);
                  setHistoryOpenWineId(null);
                }}
                isSupabaseReady={Boolean(supaRef.current)}
                requireAuth={SUPABASE_REQUIRE_AUTH}
                authUser={authUser}
                historySummaryByWineId={historySummaryByWineId}
                historySummaryLoading={historySummaryLoading}
                historyOpenWineId={historyOpenWineId}
                setHistoryOpenWineId={setHistoryOpenWineId}
                historyLoadingWineId={historyLoadingWineId}
                historyEventsByWineId={historyEventsByWineId}
                fetchWineEvents={fetchWineEvents}
                formatDateTime={formatDateTime}
              />
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>

